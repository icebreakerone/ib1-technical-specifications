# Message Delivery to Applications

Applications registered in the Trust Framework's Directory may deliver messages to other Applications outside of data transfers.

Messages are JSON data structures with a schema defined in the Registry. Each Application registers a Delivery URL in the Directory. Other Applications send messages with a `POST` request to this Delivery URL. Access control uses a x509 client certificate to identify the sender.

## Reliability

Message delivery is intended to be on a reasonable best efforts basis, with no expectation to be 100% reliable.

While failed message delivery must be retried a reasonable number of times, there is no requirement to persist messages in a database. If the server process is long-lived, in memory queuing for retry using a simple library is sufficient.

As a result:

 * Schemes must agree an SLA for availability and message delivery reliability.
 * Senders should not rely on the message being processed, even if the message as been accepted.
 * Messages must be idempotent.
 * There must be a mechanism to handle missed messages, for example:
    * Toleration of missed messages.
    * Searching logs to meet audit requirements.
    * Polling for data, in addition to notification of data availability.
    * Error results on next use of an API.


## Message format

Messages are a JSON data structure with properties:

`ib1:message`
: A property, with the value of the URL of the Trust Framework, which identifies this structure as a message.

`subject`
: A Registry URL which specifies the meaning of the message.

`body`
: A JSON data structure which is defined by the `subject` and conforms to a JSON Schema document stored in the Registry.

### Example

```json
{
  "ib1:message": "https://registry.core.trust.ib1.org/trust-framework",
  "subject": "https://registry.trust.ib1.org/message/revoke",
  "body": {
    // defined by message schema
  }
}
```

## Registry Message Format RDF document

RDF documents describing the message format are fetched from the Registry by requesting the `subject` URL. The RDF document contains:

`rdfs:comment`
: The human readable name of this type of message.

`ib1:messageSchema`
: The URL of a [JSON Schema](https://json-schema.org/) which describes the format of the `body` property in the message.


## Directory Application RDF document

The Application URL may be fetched from the Directory, and contains message delivery information alongside other information about the Application.

`ib1:messageDelivery`
: The URL of the delivery endpoint.

The Directory will include cache control headers in the response. When a delivery URL is changed, the recipient must maintain the old URL for the maximum age of the response.


## Delivery

To deliver a message, an Application:

 * Fetches the URL of the other Application from the Directory, with exponential retries if this request fails.
    * A public CA is used, with the server certificate checked against a recent public root certificate list.
    * The response may be cached.
 * Parses the RDF document to find the `ib1:messageDelivery` URL.
 * POST the message JSON document to this URL, with exponential retries if this request fails.
    * Mutual TLS is used, with the Application presenting a Directory issued client certificate, and checking the server certificate against a private CA root certificate.


## Identity of sender and recipient

The identity of the sender is sent in the client x509 certificate used in the MTLS connection for the delivery HTTP request.

The identity of the recipient is verified by confirming that the delivery URL has a server certificate, issued by the Directory, where the hostname matches the hostname of the URL in the Directory.

Either the Application URL of the sender or the Roles of the sender may be used for access control.

Some messages senders will not be naturally part of an Application, for example, OAuth Issuers. Another Application may be registered in the Directory for these components to avoid sharing certificates. This Application must have all the roles of the Applications which rely on this component.


## Advice for implementation

Sending implementations should:

 * Use a common HTTP client library.
 * When making HTTP requests, use a library which extends the HTTP client to implement exponential retry.
 * To avoid repeatedly fetching information from the Directory, when fetching the Application RDF document from the Directory, use a library which extends the HTTP client to implement caching of responses according to the `Cache-Control` headers in the response.
 * If the process which is sending messages is long-lived, the cache and the retry queues may be in memory, otherwise they must be serialised to persistent storage.
 * Log all actions and monitor SLAs.

Receiving implementations should:

 * Add the Application URL, Member URL, and Roles from the client certificate to the message before passing to a handler function or storing in a queue.
